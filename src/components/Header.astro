---
import Menu from "@icons/Menu.astro";
import AnimatedText from "@components/AnimatedText.astro";
import type { HeaderProps } from "@types";

type Props = HeaderProps;

const { navLinks } = Astro.props;
---

<header class="max-w-5xl mx-auto flex items-center justify-between px-5 py-8 relative border-b border-neutral/20">
  <a href="/" aria-label="Home link" class="flex items-center">
    <AnimatedText text="💻 Diseñador de Sitios Web 🚀" />
  </a>

  <button
    type="button"
    id="menu-button"
    class="sm:hidden text-neutral px-2 py-1"
    aria-expanded="false"
    aria-controls="main-menu"
  >
    <Menu />
  </button>

  <nav
    class="hidden text-neutral border absolute right-5 top-24 bg-black border-neutral/40 py-6 px-4 rounded-xl sm:block sm:border-0 sm:p-0 sm:static sm:bg-transparent"
    id="main-menu"
  >
    <ul class="sm:flex gap-4">
      {
        navLinks.map((link) => (
          <li class="relative">
            <a
              class={`font-medium text-base px-4 py-2 block hover:text-primary nav-item transition-colors duration-300`}
              href={link.href}
              data-nav-link
            >
              {link.text}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
</header>

<script>
  const button = document.querySelector("#menu-button");
  const menu = document.querySelector("#main-menu");
  const navItems = document.querySelectorAll("#main-menu > ul > li");

  const toggleMenu = () => {
    menu?.classList.toggle("hidden");
    const isHidden = menu?.classList.contains("hidden");
    button?.setAttribute("aria-expanded", `${!isHidden}`);
  };

  button?.addEventListener("click", toggleMenu);
  navItems.forEach((item) => {
    item?.addEventListener("click", toggleMenu);
  });

  // Función de scroll suave personalizada
  function smoothScroll(targetPosition: number, duration: number = 600) {
    const startPosition = window.pageYOffset;
    const distance = targetPosition - startPosition;
    let startTime: number | null = null;

    function animation(currentTime: number) {
      if (startTime === null) startTime = currentTime;
      const timeElapsed = currentTime - startTime;
      const progress = Math.min(timeElapsed / duration, 1);

      // Función de easing para hacer el scroll más suave
      const easeInOutQuad = (t: number) => {
        return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
      };

      window.scrollTo(0, startPosition + distance * easeInOutQuad(progress));

      if (progress < 1) {
        requestAnimationFrame(animation);
      }
    }

    requestAnimationFrame(animation);
  }

  // Variable para controlar si el scroll debe ejecutarse
  let shouldHandleScroll = false;

  // Manejador de click para los enlaces de navegación
  document.querySelectorAll('[data-nav-link]').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
      
      if (href?.startsWith('#')) {
        shouldHandleScroll = true; // Activar el scroll solo cuando se hace clic
        const targetId = href.slice(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          const headerHeight = document.querySelector('header')?.offsetHeight || 0;
          const targetPosition = targetElement.offsetTop - headerHeight;
          
          smoothScroll(targetPosition, 1000);
          // Actualizar la URL sin causar scroll
          history.pushState(null, '', href);
        }
      }
    });
  });

  // Manejar el scroll suave después de la carga de la página
  document.addEventListener('astro:page-load', () => {
    // Solo ejecutar el scroll si fue activado por un clic
    if (shouldHandleScroll) {
      const hash = window.location.hash;
      if (hash) {
        const targetElement = document.getElementById(hash.slice(1));
        if (targetElement) {
          const headerHeight = document.querySelector('header')?.offsetHeight || 0;
          const targetPosition = targetElement.offsetTop - headerHeight;
          
          setTimeout(() => {
            smoothScroll(targetPosition, 1000);
          }, 100);
        }
      }
    }
  });
</script>
